#textdomain wesnoth-wov

## Both sides are forced to recruit evenly (one of each type, then it repeats), to prevent
## recruiting only clashers, and for the player to gain experience using each unit type.
## xp earned is limited and a time limit in place so players can't use this as an xp factory
[scenario]
    id=03_The_Contention
    name= _ "The Contention"
    next_scenario=04_The_Spiral_Path
    {WOV_MAP 03_The_Contention.map}
    {TURNS 30 30 26}
    {DEFAULT_SCHEDULE_DAWN}
    carryover_percentage=0
    disallow_recall=yes

    {INTRO_AND_SCENARIO_MUSIC revelation.ogg battle.ogg}
    {EXTRA_SCENARIO_MUSIC siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC weight_of_revenge.ogg}

    [story]
        [part]
            story= _ "For ages, we of the Spiral Path have not demurred when our kin of the Straight Path spoke vaguely of the 'end of the world' lying beyond the oceans, receding ever farther as Dominants claim new ranges. However, we knew better: for we have found it written in the tides and the motion of the stars that our world is round, made like a drake's egg."
        [/part]
        [part]
            story= _ "Every hatchling's hope is to become the Dominant of a new flight. But the sinking of our islands may only prefigure a vastly greater tragedy; for if the world is bounded, our Way must end in a final war of drake against drake...or a great starvation."
        [/part]
        [part]
            story= _ "Every turn of the heavens brings us closer to that doom. We of the Spiral Path seek a way for Drake-kind to step off that wheel, before it is too late." 
        [/part]
    [/story]

    [side]
        side=1
        controller=human
        recruit=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider
        gold=100
        save_id=Player
        team_name=hero
        user_team_name= _ "Drakes"
        {FLAG_VARIANT long}
        [leader]
            {GALUN}
        [/leader]
        [unit]
            {VANK} #Sky Drake
            x,y=11,4
        [/unit]
        [unit]
            type=Drake Warrior
            x,y=7,3
        [/unit]
        [unit]
            type=Drake Arbiter
            x,y=7,4
        [/unit]
        [unit]
            type=Drake Flare
            x,y=15,3
        [/unit]
        [unit]
            type=Drake Thrasher
            x,y=15,4
        [/unit]
    [/side]

    [side]
        side=2
        controller=ai
        recruit=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider
        {GOLD 100 110 120}
        {INCOME 3 8 13}
        team_name=rival
        user_team_name= _ "Drakes"
        {FLAG_VARIANT long}
        [leader]
            id=Gribbel
            name= _ "Gribbel"
            type=Drake Flameheart
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
            facing=n
        [/leader]
        [unit]
            type=Sky Drake
            {IS_HERO}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
            x,y=11,30
            facing=n
            ai_special=guardian
        [/unit]
        [unit]
            type=Drake Arbiter
            x,y=7,30
            facing=n
            moves=0 # So they don't charge ahead
        [/unit]
        [unit]
            type=Drake Warrior
            x,y=7,31
            facing=n
            moves=0
        [/unit]
        [unit]
            type=Drake Thrasher
            x,y=15,30
            facing=n
            moves=0
        [/unit]
        [unit]
            type=Fire Drake
            x,y=15,31
            facing=n
            moves=0
        [/unit]
        [ai]
            aggression=0.75
        [/ai]
    [/side]

    [event]
        name=preload
        first_time_only=no
        [lua]
            code=<< wesnoth.game_config.kill_experience = 1 >>
        [/lua]
    [/event]

    [event]
        name=prestart
        {MODIFY_UNIT side=1 facing s}
        [objectives]
            [objective]
                condition=win
                description= _ "Defeat Gribbel"
            [/objective]
            [objective]
                condition=lose
                description= _ "Defeat of Galun"
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage=0
            [/gold_carryover]
            [note]
                description= _ "For this scenario, only 1 * level xp is earned for kills, as defeated units are merely removed from play."
            [/note]
            [note]
                description= _ "Your defeated units will be returned to you after the battle."
            [/note]
            [note]
                description= _ "Each side is allowed only intendants and recruits for this battle."
            [/note]
            [note]
                description= _ "Each side is forced to recruit unit types evenly before a type is allowed to be repeated."
            [/note]
        [/objectives]
    [/event]

    [event]
        name=start
        [message]
            speaker=narrator
            message= _ "And so the day of the Contention came. Each caste elected an Aspirant from their ranks to become the new Dominant, and each Aspirant brought with him Intendants to extend his rule over the other castes. Thus, in the ancient Way of the drakes, six times six combatants: thirty-six in all."
            image=wesnoth-icon.png
        [/message]
        # what I'm going for here is a good way to justify having the player start the contest with different resources than the opponent, for difficulty adjustments
        [message]
            speaker=narrator
            message= _ "All the skills necessary to lead a Flight were tested. Each team faced various challenges of martial ability, hunting, group coordination, strategy, & tactics; to evaluate their ability at gathering resources. The top two teams, using their gathered resources and only raw recruits, faced off in a final battle: The Contention."
            image=wesnoth-icon.png
        [/message]
        [message]
            speaker=Vank
            message= _ "I can scarce believe we are actually here. The Contention! Are we truly fit for this?"
        [/message]
        [message]
            speaker=Galun
            message= _ "Just fly and fight, Vank. I'll do the worrying."
        [/message]
     [/event]

    # Remove recruit type when recruited. When recruit list is empty, it is refilled.
    [event]
        name=recruit
        first_time_only=no
        [disallow_recruit]
            side=$unit.side
            type=$unit.type
        [/disallow_recruit]
        # TODO: store removed recruit in an side_specific array to avoid the hard-coding below
        [store_side]
            side=$unit.side
        [/store_side]
        [if]
            {VARIABLE_CONDITIONAL side.recruit equals ""}
            [then]
                [allow_recruit]
                    side=$unit.side
                    type=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider
                [/allow_recruit]
            [/then]
        [/if]
        {CLEAR_VARIABLE side}
    [/event]

    # This event must be before the next one so dialog fires.
    [event]
        name=last breath
        [filter]
            id=Galun
        [/filter]
        [message]
            speaker=unit
            message= _ "The chance at my dream, lost..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    # These two events are last breath to prevent death animation
    # Place player units on the recall list if they are defeated.
    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [put_to_recall_list]
            id=$unit.id
            heal=yes
        [/put_to_recall_list]
    [/event]
    # Remove enemy units if they are defeated, not part of previous event since ai ignores disallow_recall
    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=2
        [/filter]
        [kill]
            id=$unit.id
            animate=no
        [/kill]
    [/event]

    [event]
        name=time over
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Since neither team won in the time allotted, both lost."
        [/message]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Galun
            message= _ "We did it!"
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "By his victory, Galun earned the privilege of founding a new Flight in accordance with the Way. As custom required, he would be gifted with breeders and fledglings from each of the other Flights."
        [/message]
    [/event]
[/scenario]
