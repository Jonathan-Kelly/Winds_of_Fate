#textdomain wesnoth-wov
# This scenario is intended to be hard difficulty.
[scenario]
    id=09_Foothills
    name= _ "Foothills"
    next_scenario=10_Heart_Mountains
    {WOV_MAP 09_Foothills.map}
    {TURNS 36 34 32}
    {UNDERGROUND}
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes

    {INTRO_AND_SCENARIO_MUSIC revelation.ogg the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC into_the_shadows.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}

    [story]
        [part]
            background=story/landscape-hills-01.jpg
            story= _ "The main body of Galun's Flight lands on a rocky mountainside overlooking the forest of Wesmere, waiting for the rest of the wings to rejoin them."
        [/part]
    [/story]
    {WOV_GC_TRACK {JOURNEY_09_NEW}}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        recruit=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider, Saurian Augur, Saurian Skirmisher
        gold=100 # Player should have some carryover from previous scenario
        fog=no
        shroud=yes
        save_id=Player
        team_name=hero
        user_team_name= _ "Drakes"
        side_name= _ "Galun"
        {FLAG_VARIANT long}
        [leader]
            {GALUN}
        [/leader]
        [unit]
            {VANK}
            placement=leader
        [/unit]
        [unit]
            {ARINEXIS}
            placement=leader
        [/unit]
        [unit]
            {ZEDRIX}
            placement=leader
        [/unit]
    [/side]
    {SECOND_INTENDANT_REPLACEMENT_EVENTS}
    {WOV_DEATHS}

    [side]
        side=2
        controller=ai
        recruit=Skeleton, Revenant, Deathblade, Skeleton Archer, Bone Shooter, Walking Corpse, Soulless, Ghost, Wraith, Shadow
        {GOLD 125 175 225}
        {INCOME 3 7 11}
        team_name=undead
        user_team_name= _ "Undead"
        {FLAG_VARIANT undead}
        [leader]
            id=Lich-Lord Siravan
            name= _ "Lich-Lord Siravan"
            type=Ancient Lich
            facing=sw
        [/leader]
    [/side]
    {STARTING_VILLAGES 2 5}
#ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Shadow" 1} # One is bad enough
#else
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Shadow" 0}
#endif

    # Spiders are set up to spawn roughly every 9 turns
    [side]
        side=3
        controller=ai
        recruit=Giant Spider
        gold=0 # Given randomly in prestart
        income=1 # + 2 base + 3 villages = 6 per turn & upkeep of one recruit covered
        team_name=undead
        user_team_name= _ "Spiders"
        {FLAG_VARIANT undead}
        [leader]
            type=Giant Spider
            facing=nw
        [/leader]
        [ai]
            aggression=0.70
            [avoid]
                terrain=*^Vu
            [/avoid]
        [/ai]
    [/side]
    {STARTING_VILLAGES 3 5}

    # Serpents are set up to spawn roughly every 9 turns
    [side]
        side=4
        controller=ai
        recruit=Water Serpent
        gold=0 # Given randomly in prestart
        income=-1 # + 2 base + 2 village = 3 per turn & upkeep of one recruit covered
        team_name=undead
        user_team_name= _ "Serpents"
        {FLAG_VARIANT undead}
        [leader]
            type=Water Serpent
            facing=sw
        [/leader]
        [ai]
            aggression=0.70
            [avoid]
                terrain=*^Vu
            [/avoid]
        [/ai]
    [/side]
    {STARTING_VILLAGES 4 5}

    [side]
        side=5
        controller=ai
        gold=0
        {NO_INCOME}
        team_name=elves
        user_team_name= _ "Elves"
        {FLAG_VARIANT wood-elvish}
        no_leader=yes
        defeat_condition=never
        # units placed and spawned in events
        [ai]
            aggression=0.70
            # TODO: Focus on killing drakes
        [/ai]
    [/side]
    # wmllint: validate-on

    [event]
        name=prestart

        # For outside of the cave
        [time_area]
            terrain=M*,H*,Re,*^F*,Cud,Kud
            {DEFAULT_SCHEDULE_DUSK} #It's autumn
        [/time_area]

        # Randomly determine which monster gets to recruit on turn 1
        {RANDOM Spiders,Serpents}
        [switch]
            variable=random
            [case]
                value=Spiders
                [gold]
                    side=3
                    amount=59
                [/gold]
                [gold]
                    side=4
                    amount=4
                [/gold]
            [/case]
            [case]
                value=Serpents
                [gold]
                    side=3
                    amount=32
                [/gold]
                [gold]
                    side=4
                    amount=26
                [/gold]
            [/case]
        [/switch]
        {CLEAR_VARIABLE random}

        # Place barrels & dark powder around entrance
        {PLACE_IMAGE items/barrel.png 17 31}
        {PLACE_IMAGE items/barrel.png 17 32}
        {PLACE_IMAGE items/barrel.png 17 33}
        {PLACE_IMAGE items/barrel.png 18 31}
        {PLACE_IMAGE items/barrel.png 18 32}
        {PLACE_IMAGE items/barrel.png 18 33}
        # TODO: image for dark powder

        {PLACE_IMAGE items/gohere.png 36 01}
        {CLEAR_VARIABLE escaped_units} #initialize

        # Place units for opening dialog
        [hide_unit]
            id=Vank
        [/hide_unit]
        {TELEPORT_UNIT id=Vank      01 36}
        {TELEPORT_UNIT id=Arinexis  10 29}
        {TELEPORT_UNIT id=Zedrix    10 30}
        {MODIFY_UNIT side=1 facing sw}

        [objectives]
            [objective]
                description= _ "Seek the passage through the mountain"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Galun"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Vank"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Arinexis"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Zedrix"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description= _ "Flee members of our Flight through the passage. (Move units on to the exit tile to flee them.) (Those left behind not on the recall list will perish.)"
            [/note]
            [note]
                description= _ "Flee Galun and Vank through the passage last. (Move units to the exit tile to flee them.)"
            [/note]
            [note]
                description= _ "The main mass of frenzied prey arrives in two days. (Turn 13)"
            [/note]
        [/objectives]
    [/event]

    [event]
        name=start
        [message]
            speaker=Arinexis
            message= _ "To command respect, our alliance with dragonsss mussst have *ssome* name!"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "‘Sibblings of Setting Sun’"
        [/message]
        [message]
            speaker=Arinexis
            message= _ "‘Union of Saurgrath and Morogor’"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "‘Alignment of Moon and Sun’"
        [/message]
        [message]
            speaker=Arinexis
            message= _ "‘Sandwalkers’"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "‘Alliance of Seven Ssilver Starsss and Five Fish of Firmament’"
        [/message]
        [message]
            speaker=Arinexis
            message= _ "‘Sandfolks’!"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "Ah, that is mosst favored name - ‘Sandfolks’ - bland yet no negative connotationss that sssummon…"
        [/message]
        [message]
            speaker=Galun
            message= _ "You *will* be silent."
        [/message]
        {MODIFY_UNIT id=Vank facing ne}
        [unhide_unit]
            id=Vank
        [/unhide_unit]
        [scroll_to_unit]
            id=Vank
        [/scroll_to_unit]
        [delay]
            time=1000
        [/delay]
        [move_unit]
            id=Vank
            to_x,to_y=10,31
        [/move_unit]
        [message]
            speaker=Galun
            message= _ "Report, Vank. There are still three wings yet to regather."
        [/message]
        [message]
            speaker=Vank
            message= _ "Galun, they are routed. The forest withheld the prey’s true number. A throng of them pursues us here. On par with four of our Flights. It arrives in no more than two days.

We must retreat to the eyrie with haste."
        [/message]
        [message]
            speaker=Galun
            message= _ "Our haul is too weighty to be flown with a dozen trips. We can not forsake it. Too much depends on it."
        [/message]
        [message]
            speaker=Arinexis
            message= _ "Through thiss cave! Essscape through here…"
        [/message]
        [move_unit]
            id=Arinexis
            to_x,to_y=17,28
        [/move_unit]
        [redraw]
            clear_shroud=yes
        [/redraw]
        {MODIFY_UNIT side=1 facing ne}
        [message]
            speaker=Zedrix
            message= _ "With care, Arinexisss, with care! Fire dussst isss ssstrewn about."
        [/message]
        [message]
            speaker=Arinexis
            message= _ "Dragonsss, do not breath on the dussst!"
        [/message]
        [message]
            speaker=Vank
            message= _ "Fire Dust… enough to bring down this cave behind us…"
        [/message]
        [message]
            speaker=Galun
            message= _ "… a Cave."
        [/message]
        [message]
            speaker=Vank
            message= _ "Galun, you know we must brave it…

… we will do this. Together. You got me out of *That* cave alive. I swear to you, Galun, I will repay you this."
        [/message]
        [message]
            speaker=Galun
            message= _ "Vank… about That cave… there is something…"
        [/message]
        [sound]
            name=horn-signals/horn-1.ogg
        [/sound]
        [delay]
            time=4500 # so sound finishes before dialog starts
        [/delay]
        {SCATTER_UNITS 5 "Elvish Outrider,Elvish Rider,Elvish Rider,Elvish Rider,Elvish Rider" 1 (
            {EVERYWHERE}
            terrain=*^F*
            {SCATTER_NOT_NEXT}
         ) (side,facing=5,ne)}
        {MODIFY_UNIT side=1 facing sw}
        [message]
            speaker=Vank
            message= _ "Land gliders! I never expected they possessed such swiftness. To delay us must be their aim."
        [/message]
        [message]
            speaker=Galun
            message= _ "I need a few to hold a line across the mouth. The rest of you, into the cave!"
        [/message]
    [/event]

    [event]
        name=sighted
        id=see lich
        [filter]
            id=Lich-Lord Siravan
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [fire_event]
            name=see lich
        [/fire_event]
    [/event]

    [event]
        name=see lich
        [scroll_to_unit]
            id=Lich-Lord Siravan
        [/scroll_to_unit]
        [delay]
            time=1500
        [/delay]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "Come to test me yet again, Krahkrahs?"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "It isss to hisss sstronger brother Shek’kahan you ssspeak!"
        [/message]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "As you say."
        [/message]
        [message]
            speaker=Galun
            message= _ "I will have passage through this mountain. You are advised to move aside."
        [/message]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "Yes, indeed you will have passage through… to whence you came. I trust you can find yourselves out, otherwise my servants will show you the way."
        [/message]
    [/event]

    # TOOD: Warning dialog about forest dangerous, can't see all the elves there.

    [event]
        name=side 5 turn 7 refresh
        [sound]
            name=horn-signals/horn-1.ogg
        [/sound]
        [scroll_to]
            x,y=03,35
        [/scroll_to]
        [delay]
            time=4500 # so sound finishes before anything else
        [/delay]
        [scroll_to]
            x,y=03,35
        [/scroll_to]
        # Harm any drake in the forest before spawning elves
        [harm_unit]
            [filter]
                side=1
                [filter_location]
                    terrain=*^F*
                [/filter_location]
            [/filter]
            amount=15
            animate=yes
            fire_event=yes
        [/harm_unit]
        {SCATTER_UNITS 5 "Elvish Outrider,Elvish Rider,Elvish Rider,Elvish Rider,Elvish Rider" 1 (
            {EVERYWHERE}
            terrain=*^F*
            {SCATTER_NOT_NEXT}
        ) (side,moves,facing=5,0,ne)}
    [/event]

    [event]
        name=side 5 turn 13 refresh, side 5 turn 19 refresh, side 5 turn 25 refresh , side 5 turn 31 refresh
        [sound]
            name=horn-signals/horn-1.ogg
        [/sound]
        [scroll_to]
            x,y=03,35
        [/scroll_to]
        [delay]
            time=4500 # so sound finishes before anything else
        [/delay]
        # Kill any drake in the forest before spawning elves
        [kill]
            side=1
            [filter_location]
                terrain=*^F*
            [/filter_location]
            animate=yes
            fire_event=yes
        [/kill]
        {SCATTER_UNITS 7 "Elvish Hero,Elvish Champion,Elvish Marksman,Elvish Sharpshooter,Elvish Sorceress,Elvish Enchantress" 1 (
            {EVERYWHERE}
            terrain=*^F*
            {SCATTER_NOT_NEXT}
        ) (side,moves,facing=5,0,ne)}
    [/event]

     [event]
        name=side 5 turn 13
        # Lich-Lord dialog
        [message]
            speaker=Lich-Lord Siravan
            message= _ "What is this clamor?"
        [/message]
        # Lift fog and/or shroud
        [fire_event]
            name=see lich
        [/fire_event]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "Elves? Did you dragons tow elves to this place of fruitful solitude?

An age past, I trekked the depths beneath the Maelstrom Ocean to find a place so tranquil as this. Yet with all you creatures of every flavor pestering me here now, it seems no peace may I find for this needed work from which you all gain in ways you care not to fathom. Even if I alone completed the transmutation of our entire sub-realm, would it be heeded?"
        [/message]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "Nevermind. Dragon, I have much toil of the mind to uplift to the aether before these dim pucks undo its present corporeal manifestation. I offer you passage for a truce."
        [/message]
        [message]
            speaker=Galun
            message= _ "You shall…"
            [option]
                description= _ "have your truce."
                [command]
                    [modify_side]
                        side=2,3,4
                        team_name=hero
                    [/modify_side]
                [/command]
            [/option]
            [option]
                description= _ "meet your doom."
                # do nothing
            [/option]
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Lich-Lord Siravan
        [/filter]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "A pity. I rather fancied this body."
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            side=2
            type_adv_tree=Skeleton, Skeleton Archer, Lich
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [scroll_to_unit]
            id=$unit.id
            highlight=yes
        [/scroll_to_unit]
        [delay]
            time=1500
        [/delay]
        [message]
            side=1
            race=drake
            message= _ "Walking bones without meat! What kind of abominations are these?"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            side=2
            type_adv_tree=Walking Corpse
        [/filter]
        [filter_second]
            side=1
            race=drake
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "Yuck, this meat is rancid!"
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=36,01
        [/filter]
        [switch]
            variable=unit.id
            [case]
                value=Vank
                [message]
                    speaker=Vank
                    message= _ "Nay. Galun, I will not depart this cave before you!"
                [/message]
                [allow_undo]
                [/allow_undo]
            [/case]
            [case]
                value=Galun
                [if]
                    [have_unit]
                        id=Arinexis,Zedrix
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Galun
                            message= _ "Those saurians do not keep pace… yet I will not forsake them to such a place as this."
                        [/message]
                        [allow_undo]
                        [/allow_undo]
                    [/then]
                    [else]
                        [endlevel]
                            result=victory
                        [/endlevel]
                    [/else]
                [/if]
            [/case]
            [else]
                # store unit in a var, and put on recall list at end of scenario
                [heal_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    moves=full
                [/heal_unit]
                [store_unit]
                    [filter]
                        x,y=36,01
                    [/filter]
                    variable=escaped_units
                    mode=append
                    kill=yes
                [/store_unit]
            [/else]
        [/switch]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Vank
            message= _ "Go on, my friend. I will make sure none follow. Leave this cave behind."
        [/message]
        [message]
            speaker=Galun
            message= _ "Nay, there is no time, we leave now."
        [/message]
        [message]
            speaker=Vank
            message= _ "Tell Karron I will always regret taking his place."
        [/message]
        [message]
            speaker=Galun
            message= _ "Vank, we leave this cave together. Just like we did the first one."
        [/message]
        [message]
            speaker=Vank
            message= _ "farewell my friend"
        [/message]
        [message]
            speaker=Galun
            message= _ "vank"
        [/message]
        [move_unit]
            id=Vank
            to_x,to_y=19,34
        [/move_unit]
        {MODIFY_UNIT id=Vank facing nw}
        [message]
            speaker=Vank
            message= _ "My wings catch the Wind…"
        [/message]
        [animate_unit]
            [filter]
                id=Vank
            [/filter]
            flag=attack
            [primary_attack]
                name=fire breath
            [/primary_attack]
            [facing]
                terrain=Uu
            [/facing]
        [/animate_unit]
        {FLASH_RED ()}
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=2000
        [/delay]
        [sound]
            name=rumble.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]
        [hide_unit]
            # everyone
        [/hide_unit]
        {FADE_TO_BLACK}
        [heal_unit]
            [filter]
                id=Galun,Vank
            [/filter]
            moves=full
        [/heal_unit]
        [put_to_recall_list]
            id=Galun
        [/put_to_recall_list]
        # Vank reappears later
        [store_unit]
            [filter]
                id=Vank
            [/filter]
            variable=vank
            kill=yes
        [/store_unit]
        [kill]
            side=1
            [not]
                x,y=recall,recall
            [/not]
        [/kill]
        # unstore units to recall list
        [foreach]
            array=escaped_units
            [do]
                [unstore_unit]
                    variable=this_item
                    x,y=recall,recall
                [/unstore_unit]
            [/do]
        [/foreach]
    [/event]
[/scenario]
