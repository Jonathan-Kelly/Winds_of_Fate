#textdomain wesnoth-wov
# This scenario is intended to be hard difficulty.
[scenario]
    id=08_Foothills
    name= _ "Foothills"
    next_scenario=09_Heart_Mountains
    {WOV_MAP 08_Foothills.map}
    turns=unlimited
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes
    {DEFAULT_SCHEDULE_DUSK} #It's autumn
    {INTRO_AND_SCENARIO_MUSIC revelation.ogg the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC into_the_shadows.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}

    [story]
        [part]
            background=story/landscape-hills-01.jpg
            story= _ "The main body of Flight Gorlack descended upon a rocky mountainside overlooking the forest of Wesmere. There, Dominant Gorlack waited for his remaining wings of hunters to rejoin them."
        [/part]
    [/story]
    {WOV_GC_TRACK {JOURNEY_08_NEW}}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        recruit=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider, Saurian Augur, Saurian Skirmisher
        gold=400 # since no carryover from last scenario
        fog=no
        shroud=yes
        save_id=Player
        team_name=hero
        user_team_name= _ "Drakes"
        side_name= _ "Gorlack"
        {FLAG_VARIANT long}
        [leader]
            {GORLACK}
        [/leader]
        [unit]
            {RESHAN}
            placement=leader
        [/unit]
        [unit]
            {ARINEXIS}
            placement=leader
        [/unit]
        [unit]
            {ZEDRIX}
            placement=leader
        [/unit]
    [/side]
    {SECOND_INTENDANT_REPLACEMENT_EVENTS}
    {WOV_DEATHS}

    [side]
        side=2
        controller=ai
        recruit=Draug, Banebow, Spectre, Nightgaunt, Lich, Dread Bat, Water Serpent
        gold=0
        {INCOME 18 36 54}
        team_name=undead
        user_team_name= _ "Strange Creatures"
        {FLAG_VARIANT undead}
        [leader]
            id=Lich-Lord Siravan
            name= _ "Lich-Lord Siravan"
            type=Ancient Lich
            facing=sw
        [/leader]

        {UNIT () (Gate)  11 25 (facing=se)}
        {UNIT () (Gate)  12 25 (facing=se)}
        {UNIT () (Gate)  14 26 (facing=se)}
        {UNIT () (Gate)  15 27 (facing=se)}
        {UNIT () (Gate)  19 29 (facing=se)}
        {UNIT () (Gate)  20 29 (facing=se)}
        {UNIT () (Gate)  22 30 (facing=se)}
        {UNIT () (Gate)  23 31 (facing=se)}

        {UNIT () (Gate)  18 12 (facing=se)}
        {UNIT () (Gate)  19 13 (facing=se)}
        {UNIT () (Gate)  21 14 (facing=se)}
        {UNIT () (Gate)  22 14 (facing=se)}
        {UNIT () (Gate)  26 16 (facing=se)}
        {UNIT () (Gate)  27 17 (facing=se)}
        {UNIT () (Gate)  29 18 (facing=se)}
        {UNIT () (Gate)  30 18 (facing=se)}

        {NAMED_UNIT 3 (Gate) 30 01 ("Passage Gate") ( _ "Passage Gate") ()}
    [/side]
    {STARTING_VILLAGES 2 12}

    [side]
        side=3
        controller=ai
        recruit=Revenant, Deathblade, Bone Shooter, Necrophage, Wraith
        {GOLD 120 240 360}
        {INCOME 12 24 36}
        team_name=undead
        user_team_name= _ "Strange Creatures"
        {FLAG_VARIANT undead}
        [leader]
            id=Pet Spider
            type=Death Knight
            facing=sw
        [/leader]
        [ai]
            aggression=0.70
            [avoid]
                terrain=*^Vu
            [/avoid]
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        gold=0
        {NO_INCOME}
        team_name=elves
        user_team_name= _ "Elves"
        {FLAG_VARIANT wood-elvish}
        no_leader=yes
        defeat_condition=never
        # units placed and spawned in events
        [ai]
            aggression=0.70
            # focus on drakes
            [goal]
                name=target_unit
                [criteria]
                    side=1
                [/criteria]
                value=100
            [/goal]
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai
        gold=0
        {NO_INCOME}
        team_name=elves
        user_team_name= _ "Elves"
        {FLAG_VARIANT wood-elvish}
        no_leader=yes
        defeat_condition=never
        # units placed and spawned in events
        [ai]
            aggression=0.70
            # focus on breaking through gates
            [goal]
                name=target_unit
                [criteria]
                    side=2
                [/criteria]
                value=100
            [/goal]
        [/ai]
    [/side]
    # wmllint: validate-on

    [event]
        name=prestart

        # For the cave interior darkness.
        [time_area]
            terrain=U*, X*, Q*, W*, U*^*, *^Vu*, *^Br*, Cfr, Kfr
            {UNDERGROUND}
        [/time_area]

        # Place barrels & dark powder around entrance
        # Map uses Uue for location. Store the terrain, place a barrel on each, then convert to Uu
        [store_locations]
            terrain=Uue
            variable=barrels
        [/store_locations]
        [foreach]
            array=barrels
            [do]
                {PLACE_IMAGE items/barrel.png $this_item.x $this_item.y}
                {MODIFY_TERRAIN Uu $this_item.x $this_item.y}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE barrels}
        # TODO: image for dark powder

        {CLEAR_VARIABLE escaped_units} #initialize

        # Place units for opening dialog
        [hide_unit]
            id=Reshan
        [/hide_unit]
        {TELEPORT_UNIT id=Reshan   01 40}
        {TELEPORT_UNIT id=Arinexis 17 26}
        {TELEPORT_UNIT id=Zedrix   19 27}
        {MODIFY_UNIT side=1 facing sw}

        [remove_shroud]
            [filter]
                id=Reshan
            [/filter]
            radius=21
        [/remove_shroud]

        [objectives]
            [objective]
                description= _ "Seek the passage through the mountain"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Gorlack"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Reshan"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Arinexis"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Zedrix"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description= _ "Flee members of our Flight through the passage. (Move units on to the exit tile to flee them.)"
            [/note]
            [note]
                description= _ "Flee Gorlack and Reshan through the passage last."
            [/note]
            [note]
                description= _ "Any units left on the map at scenario end will perish. (Units on the recall list are safe.)"
            [/note]
            [note]
                description= _ "The main mass of frenzied prey arrives in two days. (Turn 13)"
            [/note]
        [/objectives]
    [/event]

    # Hack to prevent inanimate gate units from turning to face their attacker.
    [event]
        name=attack_end
        first_time_only=no
        [filter_second]
            type=Gate
        [/filter_second]
        [modify_unit]
            [filter]
                type=Gate
            [/filter]
            facing=se
        [/modify_unit]
    [/event]

    [event]
        name=start
        [message]
            speaker=Arinexis
            message= _ "To command respect, our alliance with dragonsss mussst have <b>ssome</b> name!"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "‘Sibblingss of Ssetting Sssun’"
        [/message]
        [message]
            speaker=Arinexis
            message= _ "‘Union of Saurgrath and Morogor’"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "‘Alignment of Moon and Sssun’"
        [/message]
        [message]
            speaker=Arinexis
            message= _ "‘Sandwalkersss’"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "‘Alliance of Sseven Ssilver Starsss and Five Fish of Firmament’"
        [/message]
        [message]
            speaker=Arinexis
            message= _ "‘Sandfolksss’!"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "Ah, that is mosst favored name - ‘Sandfolkss’ - bland yet no negative connotationss which sssummon…"
        [/message]
        [message]
            speaker=Gorlack
            message= _ "You <b>will</b> be silent."
        [/message]
        {MODIFY_UNIT id=Reshan facing ne}
        [unhide_unit]
            id=Reshan
        [/unhide_unit]
        [scroll_to_unit]
            id=Reshan
        [/scroll_to_unit]
        [delay]
            time=1000
        [/delay]
        [move_unit]
            id=Reshan
            to_x,to_y=17,28
        [/move_unit]
        [message]
            speaker=Gorlack
            message= _ "Report, Reshan. There are still three wings yet to regather."
        [/message]
        [message]
            speaker=Reshan
            message= _ "Gorlack, they are routed. The forest withheld the prey’s true number. A throng of them pursues us here.

We must retreat to the eyrie with due haste."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "Our haul is too weighty to be flown with a dozen trips. We can not forsake it. Too much depends on it."
        [/message]
        [message]
            speaker=Arinexis
            message= _ "Through thiss cave! Essscape through here…"
        [/message]
        [move_unit]
            id=Arinexis
            to_x,to_y=19,20
        [/move_unit]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [scroll_to_unit]
            id=Arinexis
        [/scroll_to_unit]
        {MODIFY_UNIT side=1 facing ne}
        [message]
            speaker=Zedrix
            message= _ "With care, Arinexisss, with care! Fire dussst isss ssstrewn about."
        [/message]
        [message]
            speaker=Arinexis
            message= _ "Dragonsss, do not breath on the dussst!"
        [/message]
        [message]
            speaker=Reshan
            message= _ "Fire Dust… enough to bring down this cave behind us…"
        [/message]
        [message]
            speaker=Gorlack
            message= _ "… a Cave."
        [/message]
        [message]
            speaker=Reshan
            message= _ "Gorlack, you know we must brave it…

We will do this. Together. You got me out of <b>That</b> cave alive. I swear to you, Gorlack, I will repay you this."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "Reshan… about That cave… there is something…"
        [/message]
        [sound]
            name=horn-signals/horn-1.ogg
        [/sound]
        [delay]
            time=4000 # so sound finishes before dialog starts
        [/delay]
        {SCATTER_UNITS 5 "Elvish Outrider,Elvish Rider,Elvish Rider,Elvish Rider,Elvish Rider" 0 (
            x=11-14
            y=31-33
         ) (side=4,facing=ne)}
        {MODIFY_UNIT side=1 facing sw}
        [message]
            speaker=Reshan
            message= _ "Land gliders! I never expected they possessed such swiftness. Their aim must be to delay us."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "I need a few to hold a line across the mouth. The rest of you, into the cave!"
        [/message]
    [/event]

    [event]
        name=side 4 turn refresh
        first_time_only=no
        [filter_condition]
            [lua]
                code=<< return (wesnoth.get_variable("turn_number") % 3 == 0) >>
            [/lua]
        [/filter_condition]
        [sound]
            name=horn-signals/horn-1.ogg
        [/sound]
        [scroll_to]
            x,y=14,34
        [/scroll_to]
        {SCATTER_UNITS {ON_DIFFICULTY 2 3 4} "Elvish Champion,Elvish Sharpshooter,Elvish Sylph" 1 (
            {EVERYWHERE}
            terrain=*^F*
        ) (side=4,moves,facing=5,0,ne)}
    [/event]

    [event]
        name=side 5 turn refresh
        first_time_only=no
        [filter_condition]
            [lua]
                code=<< return (wesnoth.get_variable("turn_number") % 3 == 0) >>
            [/lua]
        [/filter_condition]
        {SCATTER_UNITS {ON_DIFFICULTY 2 3 4} "Ancient Wose,Ancient Wose,Elder Wose," 1 (
            {EVERYWHERE}
            terrain=*^F*
        ) (side=5,moves,facing=5,0,ne)}
    [/event]

    [event]
        name=sighted
        id=see lich
        [filter]
            id=Lich-Lord Siravan
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [scroll_to_unit]
            id=Lich-Lord Siravan
        [/scroll_to_unit]
        # clear shroud around lich so it looks better
        [remove_shroud]
            [filter]
                id=Lich-Lord Siravan
            [/filter]
            radius=5
        [/remove_shroud]
        [delay]
            time=1500
        [/delay]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "Come to test me yet again, Krahkrahs?"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "It isss to hisss sstronger brother Shek’kahan you ssspeak!"
        [/message]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "As you say."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "I will have passage through this mountain. You are advised to move aside."
        [/message]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "Yes, indeed you will have passage through... to whence you came. I trust you can find yourselves out, otherwise my servants will show you the way..."
        [/message]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "And what is that clamor?

...Elves? Did you dragons tow elves to this place of fruitful solitude?"
        [/message]
        [message]
            speaker=Arinexis
            message= _ "*sniff* *sniff*

Dragonsss! Gate behind talking boness ssmellsss of good air. That is way through mountain. We mussst break through that gate! With hassste, dragonsss!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Lich-Lord Siravan
        [/filter]
        [message]
            speaker=Lich-Lord Siravan
            message= _  "An age past, I trekked the depths beneath the Maelstrom Ocean to find a place so tranquil as this. Yet now, it seems I may find no peace here to conduct my necessary work from which you all gain in ways you care not to fathom. Even if I alone completed the transmutation of our entire sub-realm, would it be praised?"
        [/message]
        [message]
            speaker=Lich-Lord Siravan
            message= _ "Nevermind. Dragon, I have much toil of the mind to uplift to the aether before this particular corporeal manifestation of mine may yet again be discarded, elsewise my progress will be set back a century. I offer you passage for a truce. If you agree, then my servants will be of no further trouble to you."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "You shall…"
            [option]
                description= _ "have your truce."
                [command]
                    [modify_side]
                        side=2,3
                        team_name=hero
                    [/modify_side]
                    [kill]
                        id="Passage Gate"
                    [/kill]
                    {FULL_HEAL (id=Lich-Lord Siravan)}
                [/command]
            [/option]
            [option]
                description= _ "meet your doom."
                [message]
                    speaker=Lich-Lord Siravan
                    message= _ "A pity. I rather fancied this body."
                [/message]
            [/option]
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            type_adv_tree=Lich, Draug, Banebow, Revenant, Deathblade, Death Knight
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [scroll_to_unit]
            id=$unit.id
            highlight=yes
        [/scroll_to_unit]
        [delay]
            time=1500
        [/delay]
        [message]
            side=1
            race=drake
            message= _ "Such a sickly looking creature."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                terrain=*^Ii
            [/filter_location]
        [/filter]
        [switch]
            variable=unit.id
            [case]
                value=Reshan
                [message]
                    speaker=Reshan
                    message= _ "Nay. Gorlack, I will not depart this cave before you!"
                [/message]
                [allow_undo]
                [/allow_undo]
            [/case]
            [case]
                value=Gorlack
                [if]
                    [have_unit]
                        id=Arinexis,Zedrix
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Gorlack
                            message= _ "Those two saurians do not keep pace… yet I will not forsake them to such a place as this."
                        [/message]
                        [allow_undo]
                        [/allow_undo]
                    [/then]
                    [else]
                        [endlevel]
                            result=victory
                        [/endlevel]
                    [/else]
                [/if]
            [/case]
            [else]
                # store unit in a var, and put on recall list at end of scenario
                [heal_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    moves=full
                [/heal_unit]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=escaped_units
                    mode=append
                    kill=yes
                [/store_unit]
            [/else]
        [/switch]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Reshan
            message= _ "Go on, my friend. I will make sure none follow. Leave this cave behind."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "Nay, there is no time, we leave now."
        [/message]
        [message]
            speaker=Reshan
            message= _ "Tell Karron I always regretted taking his place."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "Reshan, we leave this cave together. Just like we did the first one."
        [/message]
        [message]
            speaker=Reshan
            message= _ "farewell my friend"
        [/message]
        [message]
            speaker=Gorlack
            message= _ "reshan"
        [/message]
        [scroll_to_unit]
            id=Reshan
        [/scroll_to_unit]
        [move_unit]
            id=Reshan
            to_x,to_y=26,11
        [/move_unit]
        {MODIFY_UNIT id=Reshan facing sw}
        [scroll_to_unit]
            id=Reshan
        [/scroll_to_unit]
        [message]
            speaker=Reshan
            message= _ "My wings catch the Wind…"
        [/message]
        [animate_unit]
            [filter]
                id=Reshan
            [/filter]
            flag=attack
            [primary_attack]
                name=fire breath
            [/primary_attack]
            [facing]
                x,y=25,12
            [/facing]
        [/animate_unit]
        {FLASH_RED ()}
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=1500
        [/delay]
        [sound]
            name=rumble.ogg
        [/sound]
        [delay]
            time=500
        [/delay]
        [heal_unit]
            [filter]
                id=Gorlack,Reshan
            [/filter]
            moves=full
        [/heal_unit]
        [put_to_recall_list]
            id=Gorlack
        [/put_to_recall_list]
        # Reshan reappears later
        [store_unit]
            [filter]
                id=Reshan
            [/filter]
            variable=reshan
            kill=yes
        [/store_unit]
        [hide_unit]
            # everyone
        [/hide_unit]
        {FADE_TO_BLACK}
        [kill]
            side=1
            [not]
                x,y=recall,recall
            [/not]
        [/kill]
        # unstore units to recall list
        [foreach]
            array=escaped_units
            [do]
                [unstore_unit]
                    variable=this_item
                    x,y=recall,recall
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE escaped_units}
    [/event]
[/scenario]
